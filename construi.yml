image: docker:17.07.0-ce

default: build

environment:
  - DOCKER_PUSH_NAME=lstephen/jenkins
  - DOCKER_PUSH_USERNAME
  - DOCKER_PUSH_PASSWORD

volumes:
  - /var/run/docker.sock:/var/run/docker.sock

targets:
  jenkins-version:
    image: lstephen/curl:7.38.0
    run: -sSL https://updates.jenkins-ci.org/latestCore.txt -o JENKINS_VERSION

  versiune:
    before:
      - jenkins-version
    image: lstephe/versiune:2.0.0-RC1
    run: VERSION

  build:
    before:
      - versiune
    run:
      - /bin/sh -c "docker build -t $DOCKER_PUSH_NAME:$(cat VERSION) ."

  release:
    before:
      - build
    run: /bin/sh -c "
         echo $DOCKER_PUSH_USERNAME
      && docker login -u $DOCKER_PUSH_USERNAME -p $DOCKER_PUSH_PASSWORD
      && docker tag $DOCKER_PUSH_NAME:$(cat VERSION) $DOCKER_PUSH_NAME:latest
      && docker push $DOCKER_PUSH_NAME:$(cat VERSION)
      && docker push $DOCKER_PUSH_NAME:latest"
